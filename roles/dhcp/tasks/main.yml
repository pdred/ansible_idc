# roles/dhcp/tasks/main.yml
---
- name: Create DHCP directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "~/lab-infra/dhcp/config"
    - "~/lab-infra/dhcp/data"
    - "~/lab-infra/dhcp/src"

- name: Copy DHCP Dockerfile
  ansible.builtin.template:
    src: "Dockerfile"
    dest: "~/lab-infra/dhcp/src/Dockerfile"
    mode: '0644'

- name: Generate DHCP configuration
  ansible.builtin.template:
    src: "dhcpd.conf.j2"
    dest: "~/lab-infra/dhcp/config/dhcpd.conf"
    mode: '0644'

- name: Build DHCP container
  containers.podman.podman_image:
    name: "{{ container_registry }}/dhcp-server"
    path: "~/lab-infra/dhcp/src"
    force: true

- name: Create DHCP systemd service
  ansible.builtin.template:
    src: "dhcp-server.service.j2"
    dest: "{{ systemd_user_dir }}/dhcp-server.service"
    mode: '0644'

- name: Enable and start DHCP service
  ansible.builtin.systemd:
    name: dhcp-server
    state: started
    enabled: true
    scope: user
    daemon_reload: true

- name: Configure firewall for DHCP
  ansible.posix.firewalld:
    service: dhcp
    permanent: true
    state: enabled
  notify: "Reload firewall"
